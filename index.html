<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Caption Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Proxima Nova';
            src: url('https://fonts.cdnfonts.com/s/15042/ProximaNova-Semibold.woff') format('woff');
            font-weight: 600;
        }

        @font-face {
            font-family: 'Helvetica Neue';
            src: url('https://fonts.cdnfonts.com/s/7377/HelveticaNeueBold.woff') format('woff');
            font-weight: 700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #0095f6, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        .video-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }

        .controls-panel {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        #uploadArea {
            background: #2a2a2a;
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 60px;
            text-align: center;
            transition: all 0.3s;
        }

        #uploadArea:hover {
            border-color: #0095f6;
            background: #333;
        }

        #uploadArea.dragover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .upload-button {
            display: inline-block;
            padding: 12px 30px;
            background: #0095f6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .upload-button:hover {
            background: #0081d6;
            transform: translateY(-2px);
        }

        #videoContainer {
            position: relative;
            display: inline-block;
            margin: 0 auto;
            width: 100%;
            text-align: center;
        }

        video {
            max-width: 100%;
            max-height: 600px;
            border-radius: 8px;
            background: #000;
        }

        .caption-overlay {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 10;
            display: none;
        }

        .caption-overlay.active {
            display: block;
        }

        .caption-text {
            background: white;
            color: black;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 32px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif;
            white-space: nowrap;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 14px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .time-input {
            font-family: monospace;
            font-size: 16px;
            text-align: center;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #0081d6;
        }

        button:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .caption-list {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .caption-item {
            background: #333;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .export-button {
            background: #28a745;
            font-size: 16px;
            margin-top: 20px;
        }

        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .position-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            text-align: right;
            font-size: 12px;
            color: #888;
        }

        input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a2a;
            cursor: pointer;
        }

        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .preview-toggle {
            background: #444;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TikTok Style Video Caption Editor</h1>
        
        <div class="main-layout">
            <div class="video-section">
                <div id="uploadArea">
                    <h2>ðŸ“¹ Upload Your Video</h2>
                    <p style="margin: 20px 0;">Drag & drop or click to select</p>
                    <label for="videoInput" class="upload-button">Choose Video File</label>
                    <input type="file" id="videoInput" accept="video/*" style="display: none;">
                </div>
                
                <div id="videoContainer" class="hidden">
                    <video id="videoPlayer" controls></video>
                    <div id="captionOverlay" class="caption-overlay">
                        <div id="captionText" class="caption-text">Preview Text</div>
                    </div>
                </div>
                
                <div id="captionTimeline" class="caption-list hidden">
                    <h3>Caption Timeline</h3>
                    <div id="captionListContent">
                        <p style="text-align: center; color: #888;">No captions added yet</p>
                    </div>
                </div>
            </div>
            
            <div class="controls-panel">
                <div class="control-group">
                    <label>Caption Text</label>
                    <input type="text" id="captionInput" placeholder="Enter caption text">
                    <button class="preview-toggle" id="previewBtn">Show Preview</button>
                </div>
                
                <div class="control-group">
                    <label>Timing (HH:MM:SS)</label>
                    <div class="time-grid">
                        <input type="text" id="startTime" class="time-input" value="00:00:00" maxlength="8">
                        <input type="text" id="endTime" class="time-input" value="00:00:03" maxlength="8">
                    </div>
                    <button id="addCaptionBtn">Add Caption</button>
                </div>
                
                <div class="control-group">
                    <label>Font</label>
                    <select id="fontSelect">
                        <option value="Montserrat">Montserrat</option>
                        <option value="Proxima Nova">Proxima Nova (Semi Bold)</option>
                        <option value="Helvetica Neue">Helvetica Neue Bold</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Font Size</label>
                    <input type="range" id="fontSize" min="16" max="72" value="32">
                    <div class="range-value">Size: <span id="fontSizeValue">32</span>px</div>
                </div>
                
                <div class="control-group">
                    <label>Position</label>
                    <div class="position-grid">
                        <input type="number" id="posX" min="0" max="100" value="50" placeholder="X %">
                        <input type="number" id="posY" min="0" max="100" value="50" placeholder="Y %">
                    </div>
                    <p class="info-text">Tip: Enable preview and drag to position!</p>
                </div>
                
                <div class="control-group">
                    <label>Colors</label>
                    <div class="color-grid">
                        <div>
                            <small style="color: #888;">Background</small>
                            <input type="color" id="bgColor" value="#ffffff">
                        </div>
                        <div>
                            <small style="color: #888;">Text</small>
                            <input type="color" id="textColor" value="#000000">
                        </div>
                    </div>
                </div>
                
                <button id="exportBtn" class="export-button" disabled>Export Video with Captions</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let video = null;
        let captions = [];
        let previewMode = false;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Elements
        const videoInput = document.getElementById('videoInput');
        const uploadArea = document.getElementById('uploadArea');
        const videoContainer = document.getElementById('videoContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const captionOverlay = document.getElementById('captionOverlay');
        const captionText = document.getElementById('captionText');
        const captionTimeline = document.getElementById('captionTimeline');
        const captionListContent = document.getElementById('captionListContent');
        const exportBtn = document.getElementById('exportBtn');
        const previewBtn = document.getElementById('previewBtn');

        // Video upload - The label already triggers the input, so we only need change handler
        videoInput.addEventListener('change', handleVideoSelect);
        
        // Only handle drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files[0]) {
                handleVideoFile(e.dataTransfer.files[0]);
            }
        });

        function handleVideoSelect(e) {
            console.log('File selected:', e.target.files);
            if (e.target.files[0]) {
                handleVideoFile(e.target.files[0]);
            }
        }

        function handleVideoFile(file) {
            console.log('Handling file:', file.name, file.type, file.size);
            
            if (!file.type.startsWith('video/')) {
                alert('Please select a video file. Selected type: ' + file.type);
                return;
            }
            
            video = file;
            const url = URL.createObjectURL(file);
            console.log('Created URL:', url);
            
            videoPlayer.src = url;
            
            videoPlayer.onloadedmetadata = () => {
                console.log('Video loaded successfully');
                uploadArea.classList.add('hidden');
                videoContainer.classList.remove('hidden');
                captionTimeline.classList.remove('hidden');
                exportBtn.disabled = false;
                
                // Set max time
                const duration = videoPlayer.duration;
                document.getElementById('endTime').value = formatTime(Math.min(3, duration));
            };
            
            videoPlayer.onerror = (e) => {
                console.error('Video error:', e);
                alert('Error loading video. Please try a different file.');
            };
        }

        // Time formatting
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function parseTime(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }

        // Time input formatting
        document.getElementById('startTime').addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^\d:]/g, '');
            if (val.length === 2 || val.length === 5) val += ':';
            e.target.value = val.substring(0, 8);
        });

        document.getElementById('endTime').addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^\d:]/g, '');
            if (val.length === 2 || val.length === 5) val += ':';
            e.target.value = val.substring(0, 8);
        });

        // Preview mode
        previewBtn.addEventListener('click', () => {
            previewMode = !previewMode;
            if (previewMode) {
                previewBtn.textContent = 'Hide Preview';
                captionOverlay.classList.add('active');
                updatePreview();
            } else {
                previewBtn.textContent = 'Show Preview';
                captionOverlay.classList.remove('active');
            }
        });

        // Update preview
        function updatePreview() {
            const text = document.getElementById('captionInput').value || 'Preview Text';
            captionText.textContent = text;
            captionText.style.fontSize = document.getElementById('fontSize').value + 'px';
            captionText.style.fontFamily = `'${document.getElementById('fontSelect').value}', sans-serif`;
            captionText.style.backgroundColor = document.getElementById('bgColor').value;
            captionText.style.color = document.getElementById('textColor').value;
            
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            captionOverlay.style.left = x + '%';
            captionOverlay.style.top = y + '%';
            captionOverlay.style.transform = 'translate(-50%, -50%)';
        }

        // Control updates
        document.getElementById('captionInput').addEventListener('input', updatePreview);
        document.getElementById('fontSize').addEventListener('input', (e) => {
            document.getElementById('fontSizeValue').textContent = e.target.value;
            updatePreview();
        });
        document.getElementById('fontSelect').addEventListener('change', updatePreview);
        document.getElementById('bgColor').addEventListener('input', updatePreview);
        document.getElementById('textColor').addEventListener('input', updatePreview);
        document.getElementById('posX').addEventListener('input', updatePreview);
        document.getElementById('posY').addEventListener('input', updatePreview);

        // Dragging
        captionOverlay.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = videoContainer.getBoundingClientRect();
            const overlayRect = captionOverlay.getBoundingClientRect();
            dragOffset.x = e.clientX - overlayRect.left - overlayRect.width / 2;
            dragOffset.y = e.clientY - overlayRect.top - overlayRect.height / 2;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const rect = videoContainer.getBoundingClientRect();
            const x = ((e.clientX - rect.left - dragOffset.x) / rect.width) * 100;
            const y = ((e.clientY - rect.top - dragOffset.y) / rect.height) * 100;
            
            document.getElementById('posX').value = Math.max(0, Math.min(100, Math.round(x)));
            document.getElementById('posY').value = Math.max(0, Math.min(100, Math.round(y)));
            updatePreview();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Add caption
        document.getElementById('addCaptionBtn').addEventListener('click', () => {
            const text = document.getElementById('captionInput').value.trim();
            if (!text) {
                alert('Please enter caption text');
                return;
            }
            
            const start = parseTime(document.getElementById('startTime').value);
            const end = parseTime(document.getElementById('endTime').value);
            
            if (start >= end) {
                alert('End time must be after start time');
                return;
            }
            
            captions.push({
                text,
                start,
                end,
                x: parseInt(document.getElementById('posX').value),
                y: parseInt(document.getElementById('posY').value),
                fontSize: parseInt(document.getElementById('fontSize').value),
                font: document.getElementById('fontSelect').value,
                bgColor: document.getElementById('bgColor').value,
                textColor: document.getElementById('textColor').value
            });
            
            updateCaptionList();
            
            // Reset
            document.getElementById('captionInput').value = '';
            document.getElementById('startTime').value = formatTime(end);
            document.getElementById('endTime').value = formatTime(Math.min(end + 3, videoPlayer.duration));
            document.getElementById('posX').value = 50;
            document.getElementById('posY').value = 50;
            updatePreview();
        });

        // Update caption list
        function updateCaptionList() {
            if (captions.length === 0) {
                captionListContent.innerHTML = '<p style="text-align: center; color: #888;">No captions added yet</p>';
                return;
            }
            
            captionListContent.innerHTML = captions.map((cap, i) => `
                <div class="caption-item">
                    <span>${cap.text} (${formatTime(cap.start)} - ${formatTime(cap.end)})</span>
                    <button class="remove-btn" onclick="removeCaption(${i})">Remove</button>
                </div>
            `).join('');
        }

        window.removeCaption = function(index) {
            captions.splice(index, 1);
            updateCaptionList();
        };

        // Video playback
        videoPlayer.addEventListener('timeupdate', () => {
            if (previewMode) return;
            
            const time = videoPlayer.currentTime;
            const activeCaption = captions.find(c => time >= c.start && time <= c.end);
            
            if (activeCaption) {
                captionText.textContent = activeCaption.text;
                captionText.style.fontSize = activeCaption.fontSize + 'px';
                captionText.style.fontFamily = `'${activeCaption.font}', sans-serif`;
                captionText.style.backgroundColor = activeCaption.bgColor;
                captionText.style.color = activeCaption.textColor;
                captionOverlay.style.left = activeCaption.x + '%';
                captionOverlay.style.top = activeCaption.y + '%';
                captionOverlay.classList.add('active');
            } else {
                captionOverlay.classList.remove('active');
            }
        });

        // Export
        exportBtn.addEventListener('click', () => {
            if (captions.length === 0) {
                alert('Please add at least one caption');
                return;
            }
            
            alert('Exporting as WebM format. Use any online converter to convert to MP4 for TikTok.');
            exportVideo();
        });

        function exportVideo() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = videoPlayer.videoWidth;
            canvas.height = videoPlayer.videoHeight;
            
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, {
                mimeType: 'video/webm',
                videoBitsPerSecond: 8000000
            });
            
            const chunks = [];
            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tiktok-captions.webm';
                a.click();
            };
            
            recorder.start();
            videoPlayer.currentTime = 0;
            videoPlayer.play();
            
            function draw() {
                if (videoPlayer.ended) {
                    recorder.stop();
                    return;
                }
                
                ctx.drawImage(videoPlayer, 0, 0);
                
                const time = videoPlayer.currentTime;
                const caption = captions.find(c => time >= c.start && time <= c.end);
                
                if (caption) {
                    const fontSize = caption.fontSize * 2; // Double size for export
                    ctx.font = `bold ${fontSize}px '${caption.font}', sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const x = canvas.width * caption.x / 100;
                    const y = canvas.height * caption.y / 100;
                    const padding = fontSize * 0.6;
                    
                    const metrics = ctx.measureText(caption.text);
                    const boxWidth = metrics.width + padding * 2;
                    const boxHeight = fontSize + padding;
                    
                    ctx.fillStyle = caption.bgColor;
                    ctx.beginPath();
                    ctx.roundRect(x - boxWidth/2, y - boxHeight/2, boxWidth, boxHeight, 10);
                    ctx.fill();
                    
                    ctx.fillStyle = caption.textColor;
                    ctx.fillText(caption.text, x, y);
                }
                
                requestAnimationFrame(draw);
            }
            
            draw();
        }
    </script>
</body>
</html>
